# 一、微服务架构综述

## 1.1、架构发展史

单体架构、SOA、微服务

### 1.1.1、4S

safety、speed、scale、shading

### 1.1.2、单体架构面临的挑战

1. 维护成本增加

2. 交付周期长

3. 新人培养周期长

4. 技术更新成本高

## 1.2、微服务架构

### 1.2.1、定义（核心点）

1. 松耦合

2. 业务上下文独立

### 1.2.2、特点

1. 小——多小才算小

2. 独——独立的进程

3. 轻——轻量级通信机制

4. 松——松耦合的交付

### 1.2.3、本质

1. 以缩短交付周期为核心

2. 基于devops

3. 演进式架构

### 1.2.4、特征

1. 服务作为组件

2. 围绕业务来组建团队

3. 产品驱动而非项目驱动

4. 技术多样性

5. 业务数据独立

6. 基础设施自动化

### 1.2.5、需要考虑的因素

1. 分布式系统的复杂度
   
   1. 网络
   
   2. 性能
   
   3. 可靠性
   
   4. 异步
   
   5. 数据一致性
   
   6. 工具
   
   7. 安全

2. 运维成本

3. 组织架构

4. 服务间的集成测试

5. 服务治理

# 二、微服务生态系统

## 2.1、核心内容

1. 接入层：
   
   1. 原因：由于每个服务有独立的服务地址，可能面临升级成本高、传输效率低、协议一致性的挑战。
   
   2. 解决方案：可参考门面模式，引入接入层。
   
   3. 职责：
      
      1. 对客户隐藏多个微服务的访问地址
      
      2. 负责服务请求的路由及协议转换
      
      3. 实现公共职责，身份验证、权限控制、请求预处理

2. 业务层
   
   1. 服务拆分
      
      1. 业务功能
      
      2. 数据模型
      
      3. 限界上下文
   
   2. 服务实现：资源定义、业务逻辑、业务模型、模型存储、数据映射、网关集成
   
   3. 服务间通信：如何选择同步通信、异步通信机制，如何使用RPC、REST、消息队列
   
   4. 服务设计模式
   
   5. 数据一致性：ACID。（2PC、3PC、TCC、Sagas）

3. 支撑层
   
   1. 注册发现
   
   2. 负载均衡
   
   3. 配置管理
   
   4. 监控告警
   
   5. 日志聚合
   
   6. 调用链
   
   7. 容错

4. 基础设施：IaaS、PaaS、CaaS

## 2.2、工程实践

1. 交付流水线
   
   1. 提交
   
   2. 构建
   
   3. 验证
   
   4. 发布

2. 开发框架：演进阶段
   
   1. API为中心（Spring Boot）
   
   2. 初步支持服务治理（Spring Cloud、Dubbo、ServiceComb）
   
   3. 服务治理简化（Service Mesh）

3. 工程实践
   
   1. 服务开发
   
   2. 基础设施
   
   3. 部署管理
   
   4. 运维管理
   
   5. 交付流水线
   
   6. 服务的设计与实现
   
   7. 测试管理

# 三、微服务关键技术

## 3.1、服务设计

### 3.1.1、服务划分

**原则**：

1. 单一职责原则

2. 服务依赖原则

3. 服务自治原则

**划分策略**

1. 基于业务功能

2. 基于数据模型，也称作数据驱动方式的方式划分，是一种自底向上的实现方式。也要考虑访问机制（读密集、写密集）；读写性能

3. 限界上下文：通过建立统一语言、梳理业务流、识别事件和命令、最终寻找聚合和限界上下文

4. 基于非功能因素：
   
   1. 可复用性（通用服务）
   
   2. 资源使用（IO密集、计算密集）
   
   3. 交付频率（频繁发布抽离独立）
   
   4. 可伸缩性

**衡量合理性**

1. 服务能否独立交付

2. 服务所属团队规模

3. 是否破坏服务依赖原则

4. 是否满足单一职责原则

### 3.1.2、服务实现

**资源定义**

请求端与服务端交互时，服务端响应对业务模型的表现形式。包括表述内容与表述格式（XML、JSON）。

**业务逻辑**

**业务模型**

**存储模型**

**网关集成**

负责与其他系统协作，通过访问其他服务暴露的接口，获取数据或者提交数据。

### 3.1.3、服务间通信

**通信方式**

1. 同步
   
   1. RPC
      
      1. 对于开发人员，与本地调用一样，容易进行开发和设计
      
      2. 基于socket的二进制RPC协议，建立连接的延迟低，网络传输效率高
      
      3. RPC支持有状态的双向通信，实时性好
      
      4. 缺点是耦合高，RPC实现机制依赖特定语言和平台
   
   2. REST
      
      1. 资源
      
      2. 表述
      
      3. 状态转移：客户端能通过资源的表述，实现操作资源的目的
      
      4. 统一接口

2. 异步
   
   1. MQ
      
      1. 持久性
      
      2. 排队标准
      
      3. 安全策略
      
      4. 清理策略
      
      5. 处理通知
      
      6. 拉模式
      
      7. 推模式
      
      8. 优点：服务间解耦、异步通信、消息的持久化及恢复支持
      
      9. 缺点：实现复杂度增加、平台或者协议依赖、维护成本高
   
   2. 后台处理任务
      
      1. 任务
      
      2. 队列
      
      3. 定时器
      
      4. 执行器

### 3.1.4、服务设计模式

**链式模式**

按照数据流向进行服务拆分。

优点：实现简单直观

缺点：整个调用链采用同步机制通信，调用完成前消费者端会一直阻塞。当调用链路长时，会影响整体性能和稳定性，无法并行处理。

**聚合器模式**

当某个服务需要调用其他多个服务，进行业务功能组装时，便形成了聚合器模式。优点是能够清晰看到业务逻辑的组装，缺点是难以保证数据的唯一性。

如下场景适合聚合器模式：

1. 对业务集中处理

2. 服务间需要并发处理

如下场景不适合：

1. 不希望业务逻辑过度膨胀

**基于事件的异步模式**

服务间协作的关键点是消息。因此要保证消息发布与消息的状态保持一致。利于生成订单和发布订单生成事件，需要保持原子操作。

适用场景：

1. 用户体验有即时性要求，不希望被阻塞

2. 待处理任务比较独立，可同时运行

不适合场景：

1. 任务之间存在高度的顺序依赖关系

**事件溯源模式**

采用以事件为中心保存业务实体。每当业务实体的状态发生变化时，发布新事件到事件仓库中，系统可以通过回放来重新生成实体的当前状态。遵循的最终一致性。

由于每次发生的事件都做了持久化，因此采用事件溯源架构可以带来如下好处：

1. 准确的审计日志

2. 支持系统状态重建

适用场景：

1. 希望获得细粒度的审计日志

2. 希望记录所发生的事件并能通过重播事件来重建系统

不适用场景：

1. 数据强一致性的系统

**物化视图模式**

微服务架构中不同服务有各自的数据存储机制，这导致数据关联查询可能要经过多个服务，效率低。为了支持有效的关联查询，可通过提前生成视图的方式，将所需要的结果保存下来。当视图的源数据更改时，必须更新视图以同步信息。

适用场景：

1. 聚合服务需要从多个服务中请求数据时，在面临性能问题时，可提前创建物化视图

2. 数据库链接不稳定时，可以作为缓存使用

3. 出于安全或者隐私的原因，无法提供访问源数据的特定子集的访问权限时，可以创建物化视图将特定数据暴露为用户

不适用场景：

1. 源数据变化频繁，视图更新的开销较大

2. 对于一致性有较高要求的场景

**CQRS**

- 命令：对数据的更新

- 查询：对数据的获取

优势：

1. CQRS使用单独的查询和更新模型，能简化设计和实现，增强灵活性

2. 查询模型和更新模型可以访问不同的物理存储，能显著提高性能、可扩展性和安全性

适用场景：

1. 数据读取和写入的性能需要分开进行优化

2. 需要跨团队开发

3. 与其他系统集成，特别是与事件溯源相结合时，某个系统的临时故障不会影响其他系统的可用性

不适用场景：

1. 领域或业务规则简单

2. 简单的CRUD逻辑及相关数据访问操作

### 3.1.5、服务接入

**边缘服务**

简化外部消费者对系统的调用。可以是纯前端的页面，用于获取多个服务的数据后提供给消费者，也可以是聚合类服务，将结果进行聚合后返回给消费者。

**API网关**

- 请求路由

- 协议转换

- 公共功能：认证、鉴权、限流、流量统计

某些系统会将API网关作为聚合服务使用，不建议如此使用，因为

- 确保网关逻辑单一，聚焦于请求路由等功能

- 降低其替代成本

使用API网关，优势

1. 屏蔽服务接口的变化

2. 降低公共功能的维护成本

带来的问题：API网关是对外唯一入口，其发生故障将会导致整个系统不可用，API网关性能下降会导致所有服务的性能下降。

### 3.1.6、数据一致性

**分布式系统与数据一致性**

ACID（原子、一致、隔离、持久）

CAP(一致、可用、分区容错)

## 3.2、服务治理

## 3.3、服务运维
